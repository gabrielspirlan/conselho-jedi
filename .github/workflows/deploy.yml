name: CI/CD Pipeline - Deploy Remoto com SonarQube

on:
  push:
    branches:
      - main

jobs:
  build-and-push:
    name: Build e Push das Imagens Docker
    runs-on: ubuntu-latest
    steps:
      - name: Checkout do c√≥digo
        uses: actions/checkout@v4

      - name: Configurar QEMU
        uses: docker/setup-qemu-action@v3

      - name: Configurar Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login no Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build e Push da imagem da API
        uses: docker/build-push-action@v5
        with:
          context: ./jedi-api # Diret√≥rio da API
          push: true
          tags: ${{ secrets.DOCKERHUB_USERNAME }}/jedi-api:latest

      - name: Build e Push da imagem do Frontend
        uses: docker/build-push-action@v5
        with:
          context: ./jedi-front # Diret√≥rio do Frontend
          push: true
          tags: ${{ secrets.DOCKERHUB_USERNAME }}/jedi-front:latest # Nova imagem para o front

  sonar-analysis:
      name: An√°lise de C√≥digo com SonarQube
      runs-on: ubuntu-latest
      needs: build-and-push
      steps:
        - name: Checkout do c√≥digo
          uses: actions/checkout@v4
          with:
            fetch-depth: 0

        - name: Configurar JDK 17
          uses: actions/setup-java@v4
          with:
            java-version: '17'
            distribution: 'temurin'

        - name: Iniciar e Verificar SonarQube no servidor
          uses: appleboy/ssh-action@master
          with:
            host: ${{ secrets.REMOTE_HOST }}
            username: ${{ secrets.REMOTE_USER }}
            key: ${{ secrets.SSH_PRIVATE_KEY }}
            script: |
              docker stop sonar_starwars || true
              docker rm sonar_starwars || true
              
              echo "Iniciando cont√™iner do SonarQube..."
              docker run -d --name sonar_starwars -p 8081:9000 sonarqube:lts-community
              
              echo "Aguardando o SonarQube iniciar..."
              sleep 90

        - name: ‚òï An√°lise da API com Maven
          env:
            # Passa os secrets para o Maven usar no pom.xml
            SONAR_HOST_URL: ${{ secrets.REMOTE_HOST }}
            SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }} 
            GITHUB_TOKEN: ${{ secrets.G_TOKEN }}
          run: |
            # Executa a build e ativa o perfil 'sonar'
            mvn -f jedi-api/pom.xml verify -Psonar

        - name: üìú An√°lise do Frontend com SonarScanner
          uses: sonarsource/sonar-scanner-run-action@master
          with:
            # Aponta o scanner para o diret√≥rio do frontend
            projectBaseDir: jedi-front
          env:
            SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
            SONAR_HOST_URL: http://${{ secrets.REMOTE_HOST }}:8081
            # As propriedades abaixo ser√£o usadas pelo SonarScanner
            SONAR_SCANNER_OPTS: >-
              -Dsonar.projectKey=${{ secrets.DOCKERHUB_USERNAME }}_jedi-front
              -Dsonar.projectName=Jedi-Frontend
              -Dsonar.sources=.
              -Dsonar.exclusions=**/node_modules/**,**/dist/**
              -Dsonar.javascript.lcov.reportPaths=coverage/lcov.info

        - name: Parar e remover o cont√™iner do SonarQube
          if: always()
          uses: appleboy/ssh-action@master
          with:
            host: ${{ secrets.REMOTE_HOST }}
            username: ${{ secrets.REMOTE_USER }}
            key: ${{ secrets.SSH_PRIVATE_KEY }}
            script: |
              echo "Finalizando e removendo cont√™iner do SonarQube..."
              docker rm --force sonar_starwars || true
              sleep 30

  deploy:
    name: Deploy Remoto via Docker Run
    runs-on: ubuntu-latest
    needs: sonar-analysis
    steps:
      - name: Deploy e Verifica√ß√£o no Servidor Remoto
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.REMOTE_HOST }}
          username: ${{ secrets.REMOTE_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            # --- Vari√°veis de Ambiente ---
            API_IMAGE="${{ secrets.DOCKERHUB_USERNAME }}/jedi-api:latest"
            FRONT_IMAGE="${{ secrets.DOCKERHUB_USERNAME }}/jedi-front:latest"
            DB_IMAGE="postgres:15"
            
            APP_CONTAINER="jedi-api"
            FRONT_CONTAINER="jedi-front"
            DB_CONTAINER="postgres_starwars"
            NETWORK_NAME="jedi-network"

            # --- Prepara√ß√£o do Ambiente ---
            docker network create $NETWORK_NAME || true
            echo "Removendo cont√™ineres antigos..."
            docker stop $APP_CONTAINER || true && docker rm $APP_CONTAINER || true
            docker stop $FRONT_CONTAINER || true && docker rm $FRONT_CONTAINER || true
            docker stop $DB_CONTAINER || true && docker rm $DB_CONTAINER || true
            
            echo "Baixando imagens mais recentes..."
            docker pull $API_IMAGE
            docker pull $FRONT_IMAGE
            docker pull $DB_IMAGE
            
            # --- Deploy do Banco de Dados ---
            echo "Iniciando cont√™iner do PostgreSQL..."
            docker run -d --name $DB_CONTAINER --network $NETWORK_NAME --restart always \
              -e POSTGRES_DB=StarWars \
              -e POSTGRES_USER=postgres \
              -e POSTGRES_PASSWORD=1234 \
              -p 5544:5432 \
              -v postgres_data:/var/lib/postgresql/data \
              $DB_IMAGE
            
            echo "Aguardando o banco de dados iniciar..."
            sleep 15
            
            # --- Deploy da API Backend ---
            echo "Iniciando cont√™iner da aplica√ß√£o (API)..."
            docker run -d --name $APP_CONTAINER --network $NETWORK_NAME --restart always \
              -p 8108:8108 \
              -e SPRING_DATASOURCE_URL=jdbc:postgresql://postgres_starwars:5432/StarWars \
              -e SPRING_DATASOURCE_USERNAME=postgres \
              -e SPRING_DATASOURCE_PASSWORD=1234 \
              -e SPRING_FLYWAY_BASELINE_ON_MIGRATE=true \
              $API_IMAGE

            # --- Deploy do Frontend ---
            echo "Iniciando cont√™iner do Frontend..."
            docker run -d --name $FRONT_CONTAINER --network $NETWORK_NAME --restart always \
              -p 8102:80 \
              $FRONT_IMAGE

            # --- Verifica√ß√£o Final ---
            echo "Deploy conclu√≠do!"
            echo "Aguardando estabiliza√ß√£o dos servi√ßos..."
            sleep 30
            
            echo "-----------------------------------------------------"
            echo "Verificando cont√™ineres em execu√ß√£o no servidor..."
            docker ps
            echo "-----------------------------------------------------"